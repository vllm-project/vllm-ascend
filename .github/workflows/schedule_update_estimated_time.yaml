name: Update estimated test times

on:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 02:00 UTC
  workflow_dispatch:
    inputs:
      num_prs:
        description: 'Number of recent merged PRs to analyze'
        default: '5'
        type: string
      min_samples:
        description: 'Minimum samples required to update a value'
        default: '2'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update-estimated-times:
    name: Update estimated_time in config.yaml
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install pyyaml

      - name: Collect timing data and update config.yaml
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python3 .github/workflows/scripts/update_estimated_time.py \
            --repo "${{ github.repository }}" \
            --num-prs "${{ inputs.num_prs || '5' }}" \
            --min-samples "${{ inputs.min_samples || '2' }}" \
            --labels ready ready-for-test

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet .github/workflows/scripts/config.yaml; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to config.yaml."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "config.yaml has been updated:"
            git diff .github/workflows/scripts/config.yaml
          fi

      - name: Create pull request
        if: steps.check_changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH="auto/update-estimated-times-${{ github.run_id }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add .github/workflows/scripts/config.yaml
          git commit -m "[CI] Auto-update estimated test times in config.yaml

          Computed from timing-data artifacts of the last ${{ inputs.num_prs || '5' }} merged PRs.
          Buffer ratio: 1.1x median, rounded to the nearest 10 s."
          git push origin "$BRANCH"
          gh pr create \
            --repo "${{ github.repository }}" \
            --base main \
            --head "$BRANCH" \
            --title "chore: Auto-update estimated test times in config.yaml" \
            --body "## Summary

          This PR was auto-generated by the **Update estimated test times** workflow.

          It updates the \`estimated_time\` values in \`.github/workflows/scripts/config.yaml\`
          based on actual elapsed times collected from the last \`${{ inputs.num_prs || '5' }}\` merged PRs.

          ### Methodology
          - Only PRs labelled with **both** **ready** and **ready-for-test** are considered (full CI runs).
          - Timing data is uploaded as \`timing-data-*\` artifacts by each e2e test job.
          - For each test file, the **median** of all collected elapsed times is taken.
          - A **10 % safety buffer** is applied and the result is rounded to the nearest 10 s.
          - Only entries with at least \`${{ inputs.min_samples || '2' }}\` samples are updated.

          Please review the diff and merge if the new values look reasonable."
