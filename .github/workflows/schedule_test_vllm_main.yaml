#
# Copyright (c) 2025 Huawei Technologies Co., Ltd. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# This file is a part of the vllm-ascend project.
#
name: vLLM Main Schedule Test

on:
  # Run full e2e tests UTC+8: 10am, 16pm, 22pm, 4am
  schedule:
    - cron: '0 2,8,14,20 * * *'
  workflow_dispatch:

# Bash shells do not use ~/.profile or ~/.bashrc so these shells need to be explicitly
# declared as "shell: bash -el {0}" on steps that need to be properly activated.
# It's used to activate ascend-toolkit environment variables.
defaults:
  run:
    shell: bash -el {0}

jobs:
  e2e-full:
    uses: ./.github/workflows/_e2e_test.yaml
    with:
      vllm: main
      runner: linux-aarch64-a2
      image: swr.cn-southwest-2.myhuaweicloud.com/base_image/ascend-ci/cann:8.5.0-910b-ubuntu22.04-py3.11
      contains_310: false
      type: full
      collect_test_stats: ${{ github.event_name == 'workflow_dispatch' || github.event.schedule == '0 20 * * *' }}

  e2e-light:
    uses: ./.github/workflows/_e2e_test.yaml
    with:
      vllm: main
      runner: linux-aarch64-a2
      image: swr.cn-southwest-2.myhuaweicloud.com/base_image/ascend-ci/cann:8.5.0-910b-ubuntu22.04-py3.11
      contains_310: false
      type: light
      collect_test_stats: ${{ github.event_name == 'workflow_dispatch' || github.event.schedule == '0 20 * * *' }}

  update-config:
    name: Update config.yaml (PR)
    needs: [e2e-full, e2e-light]
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.schedule == '0 20 * * *' }}
    runs-on: ubuntu-latest
    env:
      UPSTREAM_OWNER: vllm-project
      UPSTREAM_REPO: vllm-ascend
      FORK_OWNER: vllm-ascend-ci
      FORK_REPO: vllm-ascend
    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FORK_OWNER }}/${{ env.FORK_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          ref: main

      - name: Download stats artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts
          pattern: test-stats-*
          merge-multiple: true

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream
          git remote -v

      - name: Set Git user info
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Create or switch to update branch
        run: |
          BRANCH_NAME="auto-pr/update-test-times"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> "$GITHUB_ENV"
          git checkout -B "${BRANCH_NAME}" upstream/main

      - name: Merge stats into test_stats.json
        id: merge
        run: |
          python3 - <<'PY'
          import glob
          import json
          import os

          merged = []
          for path in sorted(glob.glob('artifacts/**/test_stats_*.json', recursive=True)):
              with open(path, 'r', encoding='utf-8') as f:
                  merged.extend(json.load(f))

          with open('test_stats.json', 'w', encoding='utf-8') as f:
              json.dump(merged, f, indent=2)

          print(f"Merged {len(merged)} record(s) into test_stats.json")

          out = os.environ.get('GITHUB_OUTPUT')
          if out:
              with open(out, 'a', encoding='utf-8') as f:
                  f.write(f"has_stats={'true' if len(merged) > 0 else 'false'}\n")
          PY

      - name: Install update dependency (ruamel.yaml)
        if: ${{ steps.merge.outputs.has_stats == 'true' }}
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install ruamel.yaml

      - name: Update config.yaml from stats
        if: ${{ steps.merge.outputs.has_stats == 'true' }}
        run: |
          python3 .github/workflows/scripts/update_test_times.py \
            --config .github/workflows/scripts/config.yaml \
            --stats test_stats.json

      - name: Commit changes (if any)
        if: ${{ steps.merge.outputs.has_stats == 'true' }}
        run: |
          git add .github/workflows/scripts/config.yaml
          if git diff --cached --quiet; then
            echo "No config.yaml changes; skipping push/PR."
            echo "HAS_CHANGES=false" >> "$GITHUB_ENV"
            exit 0
          fi
          git commit -s -m "ci: update e2e test estimated_time"
          echo "HAS_CHANGES=true" >> "$GITHUB_ENV"

      - name: Push branch to fork
        if: ${{ steps.merge.outputs.has_stats == 'true' && env.HAS_CHANGES == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git push -f origin "${BRANCH_NAME}"

      - name: Create or reuse PR in upstream
        if: ${{ steps.merge.outputs.has_stats == 'true' && env.HAS_CHANGES == 'true' }}
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const upstreamOwner = process.env.UPSTREAM_OWNER;
            const upstreamRepo = process.env.UPSTREAM_REPO;
            const forkOwner = process.env.FORK_OWNER;
            const branchName = process.env.BRANCH_NAME;
            const head = `${forkOwner}:${branchName}`;

            const existing = await github.rest.pulls.list({
              owner: upstreamOwner,
              repo: upstreamRepo,
              state: 'open',
              head,
            });

            if (existing.data.length > 0) {
              core.info(`PR already exists: #${existing.data[0].number} (${existing.data[0].html_url})`);
              return;
            }

            const pr = await github.rest.pulls.create({
              owner: upstreamOwner,
              repo: upstreamRepo,
              head,
              base: 'main',
              title: '[CI] update e2e test estimated_time',
              body: `Automated update of .github/workflows/scripts/config.yaml based on scheduled test durations.\n\n` +
                `Guardrails:\n` +
                `- Skip anomalous durations (too long or near-zero)\n` +
                `- Only update passed tests\n` +
                `- EMA with adaptive alpha\n\n` +
                `Workflow run: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            });
            core.info(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
