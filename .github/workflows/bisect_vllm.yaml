#
# Copyright (c) 2025 Huawei Technologies Co., Ltd. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# This file is a part of the vllm-ascend project.
#

name: Bisect vLLM

on:  
  pull_request:
    branches:
      - 'main'
    paths:
      - '.github/workflows/bisect_vllm.yaml'
      - 'tools/bisect_vllm.sh'
      - 'tools/bisect_helper.py'
  workflow_dispatch:
    inputs:
      good_commit:
        description: 'Known good vllm commit (leave empty to auto-detect from main branch)'
        required: false
        default: ''
      bad_commit:
        description: 'Known bad vllm commit (leave empty to auto-detect from current branch)'
        required: false
        default: ''
      test_cmd:
        description: 'Failing pytest command(s), semicolon-separated for batch mode'
        required: true
        default: 'pytest -sv tests/e2e/multicard/4-cards/long_sequence/test_accuracy.py'

# Bash shells do not use ~/.profile or ~/.bashrc so these shells need to be explicitly
# declared as "shell: bash -el {0}" on steps that need to be properly activated.
# It's used to activate ascend-toolkit environment variables.
defaults:
  run:
    shell: bash -el {0}

jobs:
  # ================================================================
  # Centralized parameter resolution + matrix generation:
  # - workflow_dispatch: uses user-provided inputs
  # - pull_request: falls back to defaults defined here
  #
  # Supports batch mode: semicolon-separated test commands are grouped
  # by (runner, image, test_type) into a matrix for parallel execution.
  # ================================================================
  set-params:
    name: Set parameters
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.resolve.outputs.matrix }}
      good_commit: ${{ steps.resolve.outputs.good_commit }}
      bad_commit: ${{ steps.resolve.outputs.bad_commit }}
    steps:
      - name: Checkout vllm-ascend repo
        uses: actions/checkout@v6

      - name: Resolve parameters and build matrix
        id: resolve
        run: |
          # ---- PR-trigger defaults (edit here) ----
          DEFAULT_TEST_CMD="pytest -sv tests/e2e/singlecard/test_llama32_lora.py; pytest -sv tests/e2e/multicard/4-cards/long_sequence/test_accuracy.py; pytest -sv tests/ut/spec_decode/test_eagle_proposer.py; pytest -sv tests/e2e/singlecard/test_models.py; pytest -sv tests/e2e/multicard/2-cards/test_aclgraph_capture_replay.py"
          DEFAULT_GOOD_COMMIT="d7e17aaacd5ed1b4b4be6bcfef3a1b7cbc84fc9a"
          DEFAULT_BAD_COMMIT="18e7cbbb158a86bdc76585e64ada795bf1c0d435"
          # ---- end defaults ----

          # Resolve test_cmd(s)
          INPUT_TEST_CMD="${{ inputs.test_cmd }}"
          if [[ -n "${INPUT_TEST_CMD}" ]]; then
            TEST_CMDS="${INPUT_TEST_CMD}"
          else
            TEST_CMDS="${DEFAULT_TEST_CMD}"
          fi

          # Resolve commits
          INPUT_GOOD="${{ inputs.good_commit }}"
          INPUT_BAD="${{ inputs.bad_commit }}"
          echo "good_commit=${INPUT_GOOD:-${DEFAULT_GOOD_COMMIT}}" >> "$GITHUB_OUTPUT"
          echo "bad_commit=${INPUT_BAD:-${DEFAULT_BAD_COMMIT}}" >> "$GITHUB_OUTPUT"

          # Build matrix from semicolon-separated commands
          python3 tools/bisect_helper.py batch-matrix \
            --test-cmds "${TEST_CMDS}" \
            --output-format github

  bisect:
    name: Bisect (${{ matrix.group }})
    needs: set-params
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.set-params.outputs.matrix) }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 360
    container:
      image: ${{ matrix.image }}
      env:
        VLLM_LOGGING_LEVEL: ERROR
        VLLM_USE_MODELSCOPE: True
        HF_HUB_OFFLINE: 1
        # UT needs these for CPU-only environment (matching _unit_test.yaml)
        SOC_VERSION: ${{ matrix.test_type == 'ut' && 'ascend910b1' || '' }}
        MAX_JOBS: ${{ matrix.test_type == 'ut' && '4' || '' }}
        COMPILE_CUSTOM_KERNELS: ${{ matrix.test_type == 'ut' && '0' || '' }}
        # 2-cards needs HCCL_BUFFSIZE (matching _e2e_test.yaml 2-cards jobs)
        HCCL_BUFFSIZE: ${{ matrix.runner == 'linux-aarch64-a3-2' && '1024' || '' }}
    steps:
      # ================================================================
      # Common: config mirrors + install git
      # ================================================================
      - name: Config mirrors
        run: |
          sed -Ei 's@(ports|archive).ubuntu.com@cache-service.nginx-pypi-cache.svc.cluster.local:8081@g' /etc/apt/sources.list || true
          pip config set global.index-url http://cache-service.nginx-pypi-cache.svc.cluster.local/pypi/simple || true
          pip config set global.trusted-host cache-service.nginx-pypi-cache.svc.cluster.local || true
          apt-get update -y
          apt install git -y

      # ================================================================
      # Common: checkout repos (before system deps, packages.txt needed)
      # ================================================================
      - name: Checkout vllm-project/vllm repo
        uses: actions/checkout@v6
        with:
          repository: vllm-project/vllm
          ref: ${{ needs.set-params.outputs.bad_commit }}
          path: ./vllm-empty
          fetch-depth: 500

      - name: Checkout vllm-project/vllm-ascend repo
        uses: actions/checkout@v6
        with:
          path: ./vllm-ascend
          fetch-depth: 0

      - name: Check npu and CANN info
        run: |
          npu-smi info || echo "npu-smi not available (expected on CPU runners)"
          if [ -d /usr/local/Ascend/ascend-toolkit/latest ]; then
            cat /usr/local/Ascend/ascend-toolkit/latest/"$(uname -i)"-linux/ascend_toolkit_install.info
          fi

      # ================================================================
      # E2E: system deps (with clang)
      # ================================================================
      - name: Install system dependencies (e2e)
        if: ${{ matrix.test_type == 'e2e' }}
        working-directory: ./vllm-ascend
        run: |
          apt-get -y install `cat packages.txt` || true
          apt-get -y install gcc g++ cmake libnuma-dev clang-15 || true
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-15 20 || true
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-15 20 || true

      # ================================================================
      # UT: system deps (matching _unit_test.yaml)
      # ================================================================
      - name: Install system dependencies (ut)
        if: ${{ matrix.test_type == 'ut' }}
        run: |
          apt-get install -y python3-pip vim wget net-tools gcc g++ cmake libnuma-dev curl gnupg2

      # ================================================================
      # E2E: install vllm (editable) + vllm-ascend (editable)
      # ================================================================
      - name: Install vllm from source (e2e)
        if: ${{ matrix.test_type == 'e2e' }}
        working-directory: ./vllm-empty
        run: |
          VLLM_TARGET_DEVICE=empty pip install -e .

      - name: Install vllm-ascend (e2e)
        if: ${{ matrix.test_type == 'e2e' }}
        working-directory: ./vllm-ascend
        env:
          PIP_EXTRA_INDEX_URL: https://mirrors.huaweicloud.com/ascend/repos/pypi
        run: |
          python3 -m pip install -r requirements-dev.txt
          python3 -m pip install -v -e .

      # ================================================================
      # UT: install vllm (non-editable) + vllm-ascend (non-editable)
      # ================================================================
      - name: Install vllm from source (ut)
        if: ${{ matrix.test_type == 'ut' }}
        working-directory: ./vllm-empty
        run: |
          VLLM_TARGET_DEVICE=empty python3 -m pip install . --extra-index https://download.pytorch.org/whl/cpu/
          python3 -m pip uninstall -y triton

      - name: Install vllm-ascend (ut)
        if: ${{ matrix.test_type == 'ut' }}
        working-directory: ./vllm-ascend
        run: |
          export PIP_EXTRA_INDEX_URL=https://mirrors.huaweicloud.com/ascend/repos/pypi
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/Ascend/ascend-toolkit/latest/x86_64-linux/devlib
          python3 -m pip install -v . --extra-index https://download.pytorch.org/whl/cpu/
          python3 -m pip install -r requirements-dev.txt --extra-index https://download.pytorch.org/whl/cpu/

      # ================================================================
      # Common: run bisect (batch or single)
      # ================================================================
      - name: Run bisect
        working-directory: ./vllm-ascend
        env:
          VLLM_WORKER_MULTIPROC_METHOD: spawn
          VLLM_USE_MODELSCOPE: True
          PYTORCH_NPU_ALLOC_CONF: max_split_size_mb:256
          TORCH_DEVICE_BACKEND_AUTOLOAD: ${{ matrix.test_type == 'ut' && '0' || '' }}
          LD_LIBRARY_PATH: ${{ matrix.test_type == 'ut' && '/usr/local/Ascend/ascend-toolkit/latest/x86_64-linux/devlib' || '' }}
        run: |
          chmod +x tools/bisect_vllm.sh

          # Write test commands to file for batch mode
          echo "${{ matrix.test_cmds }}" > /tmp/bisect_cmds.txt

          tools/bisect_vllm.sh \
            --vllm-repo ../vllm-empty \
            --ascend-repo . \
            --fetch-depth 500 \
            --step-timeout 1200 \
            --total-timeout 20400 \
            --test-cmds-file /tmp/bisect_cmds.txt \
            ${{ needs.set-params.outputs.good_commit && format('--good {0}', needs.set-params.outputs.good_commit) || '' }} \
            ${{ needs.set-params.outputs.bad_commit && format('--bad {0}', needs.set-params.outputs.bad_commit) || '' }}
