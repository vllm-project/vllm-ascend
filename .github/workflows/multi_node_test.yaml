name: 'e2e test / multi-dp'

on:
  #   schedule:
  #     - cron: "0 */4 * * *"
    workflow_dispatch:

# Bash shells do not use ~/.profile or ~/.bashrc so these shells need to be explicitly
# declared as "shell: bash -el {0}" on steps that need to be properly activated.
# It's used to activate ascend-toolkit environment variables.
defaults:
  run:
    shell: bash -el {0}

# only cancel in-progress runs of the same workflow
# and ignore the lint / 8 cards test type
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    strategy:
      max-parallel: 2
      matrix:
        vllm_version: [main]
    runs-on: linux-aarch64-a3-0
    container:
      image: m.daocloud.io/quay.io/ascend/cann:8.2.rc1-a3-ubuntu22.04-py3.11
      env:
        KUBECONFIG: /root/.cache/.kube/kubeconfig.yaml
        NAMESPACE: vllm-project
    steps:
        - name: Install system denpendencies
          run: |
           # configure apt and pip source
           sed -i 's|ports.ubuntu.com|mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list
           pip config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple

           apt-get update -y && apt-get install -y git curl apt-transport-https ca-certificates gnupg
           curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
           chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg # allow unprivileged APT programs to read this keyring 
           echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
           chmod 644 /etc/apt/sources.list.d/kubernetes.list

           TOKEN=`echo -n "x-access-token:${{ secrets.ADMIN_PTA }}" | base64`
           git config --global http.https://gh-proxy.test.osinfra.cn/.extraheader "AUTHORIZATION: basic $TOKEN"

        - name: Install kubectl
          run: |
            apt-get update -y
            apt-get install -y kubectl

        - name: Checkout code
          uses: actions/checkout@v4

        - name: Prepare scripts
          run: |
            rm -rf /root/.cache/tests/scripts/run.sh
            mkdir -p /root/.cache/scripts/
            cp -r tests/e2e/multi_node/scripts/run.sh /root/.cache/tests/e2e/multi_node/

        - name: Launch cluster
          run: |
            kubectl apply -f tests/multi_node_mp/lws.yaml

        - name: Post process
          if: always()
          run: |
            kubectl get pods -n $NAMESPACE
            kubectl delete -f tests/multi_node_mp/lws.yaml
